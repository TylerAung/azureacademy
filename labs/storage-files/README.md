# Azure Files Storage

SMB file share; directory structure; shared access - multiple components, cloud & on-prem

## Reference

- [Azure Files overview](https://docs.microsoft.com/en-gb/azure/storage/files/storage-files-introduction)

- [`az storage share` commands](https://docs.microsoft.com/en-us/cli/azure/storage/share?view=azure-cli-latest)

- [`az storage file` commands](https://docs.microsoft.com/en-us/cli/azure/storage/file?view=azure-cli-latest)

- [Microsoft Learn: Configure Azure files and Azure File Sync](https://docs.microsoft.com/en-us/learn/modules/configure-azure-files-file-sync/)

## Create a File Share

Azure Files is a feature of a Storage Account. Start by creating the RG and SA:

```
az group create -n labs-storage-files  -l southeastasia --tags courselabs=azure

az storage account create -g labs-storage-files  -l southeastasia --sku Standard_LRS -n labsstoragefileses
```

Standard redundancy options.

```
az storage share create --help

az storage share create -n labs --account-name labsstoragefileses
```

Check the share in the Portal - you'll see the tier and quota have used the default values.

Open the share and you'll see you can work with files in a similar way to blobs:

- create a new directory called `uploads`
- upload the document.txt file to the `uploads` directory
- open the file details

You can view the file contents and edit it directly in the Portal. You'll see there's a URL. Try to download the file:

```
curl -o download.txt https://labsstoragefileses.file.core.windows.net/labs/uploads/document.txt

cat download.txt
```

> File shares default to no public access

You can give access to a file share but you need to generate a SAS token at the account level.

## Mounting the share & rotating keys

Typically you'll mount the share to your local filesystem instead. Navigate back to the share in the Portal and click _Connect_. You'll see the instructions to mount your share in Windows, macOS and Linux.

e.g. on the Mac:

```
open smb://<storage-account-name>:<storage-account-key>@<storage-account-name>.file.core.windows.net/<share-name>
```

Mount the share on your local machine. Confirm you can see the document.txt and edit the contents - open it again in the Portal to check your changes are persisted. Make a change in the Portal and confirm you see it in your local share.

> You may see interesting messages about the file sytsem capabilities - SMB doesn't have all the features of your native OS filesystem.

Authentication to a share uses the storage account key - this is autogenerated when the account is created. It gives you access to the whole storage account.

Check the SA in the Portal, open _Access keys_. You'll see _key1_ and _key2_ both with options to rotate them. If you share your keys you should rotate them regularly - clients will need to know the new key.

```
az storage account keys list --account-name labsstoragefileses
```

You'll see the value for key1 is the one you used to mount the share. Renew the key:

```
az storage account keys renew --key primary -g labs-storage-files -n labsstoragefileses 
```

Now try to open the file from your local share again. It will fail, maybe with an error message - depending on your OS. You need to open or configure the mount again with the new key.

## Mount the share in a VM

Manual steps - capture in an init script (cloud-init or PowerShell)

- [](/labs/storage-files/cloud-init/mount-share.sh) - add your account name and key

```
az vm create -g labs-storage-files -n vm01 --image UbuntuLTS --custom-data labs/storage-files/cloud-init/mount-share.sh
```

ssh <ip-address>

ls /mnt/labs

cat /mnt/labs/uploads/document.txt

echo 'EDITED once more by Azure VM.' >> /mnt/labs/uploads/document.txt

exit


- verify changes in the Portal

## Lab

- create a premium SSD share, with a 100GB capacity. how is this different from the standard file share?